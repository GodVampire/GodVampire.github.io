---
title: TCP/IP
categories: 
- 网络篇
tags: [网络协议, 基础学习]
---



> 写在前面

​	对于这些内容也是第一次整理，对很多知识也是一知半解，链接很多，搬用的也不少，错误的地方应该也有，表述不清楚的~凑合着过吧。



> 本篇主要讲述

1. **Tcp/IP**模型 和 **OSI**模型
2. 思考网络协议的运作方式
3. 实践抓包
4. **TCP/IP** 协议如何处理数据通信
5. 各层的 Header 分析
6. 理解**TCP/IP**各层
7. **Http **和**Https**、**IPv4 **和**IPv6**、**TCP **和**UDP**
8. 加密

<!-- more -->

#### 热身

​	还是采用QA的形势吧,自问自答,让内容一目了然

Q: 为什么要来了解计算机网络知识，了解这些做什么?？

A: 	1. [一篇讲Tcp/Ip](https://www.zhihu.com/question/51074319)的开头描述的很有意思，说先从汽车行业说起,99%的人可能只会开车，不会修理汽车，也不了解汽车内部构造，但是不影响使用汽车。但是对于汽车维修工程师，需要精通汽车内部结构。同理计算机也是如此，作为一名经常和计算机打交道的编程人员，当遇到网络问题，或者需要抓包等情况，还是需要有一定的知识储备的。emm~ 很到位。

​	2.那么了解这些主要是为了：方便以后的使用，探知网络体系构造，也增强一下自己的学习能力，而且这些对于编程开发知道这些也是只少不多。



Q: 如果之前有学习过，为什么认知不深?
A: 	1.可能只是平时在使用Http,或者了解Tcp/Ip,Scoket,DNS,IP等等关键字,但是却始终觉得有点混淆。
  	2.可能是缺乏基础知识(我的也很差2333),或者是只看网络互联的局部细节,没有整体的概念,就容易理解不到位。
​	 3.或者是知道的概念很多,却不知道他们运用于什么地方,不知道如何生效的。
   所以,这次不在选择走马观花,动手对整体把握一下,实践起来。



Q: 那么多知识内容,怎样去学习?
A:  	还是从汽车维修来说，**如果只是看汽车的维修手册，即使看千遍也不一定会维修汽车。**那么想熟练的地维修，采用这样的模式：**动手 + 理论 + 师傅指导**  ,动手去亲自抓一抓包，或者写一个小程序，分析一下网络请求中到底经历了什么？

​	或者就是先了解功能预期达成的目的，再了解基本逻辑原理，最后串起实现细节。专业点说是自顶至下的方式。不论是功能设计还是学习。

​	最多最复杂的应该就是网络协议了，谨记“网络协议因需求而产生，以解决实际问题为目的”，因此学习某个协议一定要了解它的应用场景和提出目的。



Q: 哪些需要深入，哪些只需要看看而已。
A: 可以先从我们需要关心，或者感兴趣的，或者经常见到的作为驶入点，容易激发兴趣，然后一层一层的剥开，露出真相。



#### 简介

**互联网协议族**（英语：Internet Protocol Suite，缩写IPS）是一个网络通信模型，以及一整个家族，为互联网的基础通信架构。它常被通称为**TCP/IP协议族**（英语：TCP/IP Protocol Suite，或TCP/IP Protocols），简称**TCP/IP**。

因为该协议家族的两个核心协议：TCP（[传输控制协议](https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE)）和IP（[网际协议](https://zh.wikipedia.org/wiki/%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE)），为该家族中最早通过的标准。由于在网络通讯协议普遍采用分层的结构，当多个层次的协议共同工作时，类似计算机科学中的堆栈，因此又被称为**TCP/IP协议栈**

TCP/IP提供点对点的链接机制，将数据应该如何封装、定址、传输、路由以及在目的地如何接收，都加以标准化。它将软件通信过程抽象化为四个抽象层，采取协议堆栈的方式，分别实现出不同通信协议。协议族下的各种协议，依其功能不同，被分别归属到这四个层次结构之中，常被视为是简化的七层[OSI模型](https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B)。

这里的解释都比较官方一点，才疏学浅也不好对这些下定义，只好照搬[这里](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F#cite_note-2).

> Tip : 这里注意一下 OSI七层模型 和  TCP/IP 协议的区分

OSI模型 也就是学时课本中常见到的应用层、表示层、回话层、传输层、网络层、数据链路层、以及物理层，这七层。顺序依次是7654321层。

TCP/IP 协议为四个抽象层,即应用层、传输层、网络互联层、网络接口层，这四层。

OSI模型是国际互连网标准组织定义出来是网络模型，分的很细 但是实际应用中却大部分只用到了TCP/IP的这4层，所以现在都说TCP/IP模型了

 ISO/OSI参考模型只是理论上的模型，并没有成熟的体系，而TCP/IP参考模型已经成为“实际上的国际标准”。

好吧，还是苦涩难懂的话，还是看这里做了半天的图吧 ：

{% asset_img  picture1.png %}

#### 思考网络协议的运作方式

​	使用计算机最大的好处是：当电脑接入互联网时，你可以坐着不动和别人打交道，而不用像发个邮件一样等待好久。那么当你使用聊天软件的时候，消息是怎么传递到你想要发送的人手中呢？当你打实时竞技游戏的时候，是服务器是怎么把数据传递到你的电脑中的呢？带着这些疑问我们来思考一下计算机网络大概是怎么运转的。

​	既然提到邮件，大家应该都写过信件，或者快递吧。那么根据填写的邮政编码，收件人地址就是能送到收件人手中，应该不难理解。那么计算机网络也是人类发明的，比葫芦画瓢，想把一条网络信息发送到你想要的人手中，可以类比一下  ，标准的信件格式是要在信封上写“**收信人地址”**和“**寄信人地址”**（由此引入IP地址），“**收信人地址”**对应数据包里IP头部中的“**目的ip地址”**，“**寄信人地址”**对应数据包里IP头部中的“**源ip地址”**，写上寄信、收信两个地址就可以保证信件可以邮寄到目的地了。那么有了地址，怎么找到具体是那个人呢，所以我们要在信件上添加**收信人姓名**和**寄信人姓名**（由此引入端口号），这个时候收件人姓名就对应数据包里TCP协议头部中的目的[端口号](https://www.zhihu.com/question/22577025/answer/125711899)，寄信人姓名对应数据包里TCP协议头部中的源端口号([来源](https://www.zhihu.com/question/51074319/answer/124733136)，或者看大神更多的详细解释)。

​	你要知道计算机网络里的数据交换都是像我们日常邮寄信件一样通过各种的数据包来传递的，理解了数据包的作用之后你就应该开始学习计算机网络是如何把数据包传输到目的地的？例如我们的电脑在生成数据包时是怎么知道对方电脑的ip地址的，（由此引入DNS）？我们的信件是最开始是通过邮局帮我们邮寄的，那么我们的电脑的数据包应该由谁来帮我们传输呢？（由此引入网关），网关又是如何帮我们把数据包传输到目的地的？（由此引入各种路由协议）。(这段也写的非常好...)

​	那么了解了大概的方式之后，我们就去抓个包试试。

#### 去实践

> 工具 + 教程

[Charles](https://www.jianshu.com/p/68684780c1b0)(IOS常用的抓包工具)，[wireshark](http://www.cnblogs.com/TankXiao/archive/2012/10/10/2711777.html)(PC端抓包工具)，[tcpdump](http://mrpeak.cn/blog/tutorial-tcpdump/)(嗅探工具)

> 实践

Cherles平时也经常用，没用过的童鞋点击上面链接

用了大半天捣鼓wireshark虽然大概都熟悉了，按照教程走了几遍，看到了TCP中的三次握手(如何三次握手就不叙述了)，了解一下Arp欺骗,可是到最后还是没看出来怎么传递数据的~

tcpdump文章中已经写的很好了，可以仔细看看，具体就不细说了，亲试可用，有空也可以看看他的其他作品~

那么使用过之后还是有很多疑惑的话，那么带着这些问题去了解更多~

#### TCP/IP 协议如何处理数据通信

​	包是指通过网络传输的基本信息单元。基本的包由头（包含发送系统和接收系统的地址）和正文或**有效负荷**（包含要传送的数据）组成。当包经由 TCP/IP 协议栈时，每一层上的协议都会在基本头中添加或删除字段。当发送系统上的协议向包头中添加数据时，此过程即被称为**数据封装**。此外，每一层对于已更改的包都有不同的称呼，如下图中所示。

{% asset_img  picture2.png %}

> 接收主机如何处理包

​	当包到达接收主机时，包便会按照其发送顺序的相反顺序经由 TCP/IP 协议栈。上图说明了此路径。此外，接收主机上的每种协议还会删除头信息，该信息通过发送主机上的对等协议附加到包中。将会发生以下过程：

1. 物理网络层接收帧格式的包。物理网络层会计算包的 CRC，然后将帧发送到数据链路层。
2. 数据链路层检验帧的 CRC 是否正确，然后删除帧标题和 CRC。最后，数据链路层将帧发送到 Internet 层。
3. Internet 层读取头中的信息以识别传输。然后，Internet 层将确定包是否为分段包。如果分段进行传输，则 IP 会将分段重新汇编成原始数据报。然后，IP 将删除 IP 数据包头并将数据报传递到传输层协议。
4. 传输层（TCP、SCTP 和 UDP）读取头以确定必须接收数据的应用层协议。然后，TCP、SCTP 或 UDP 将删除其相关的头。TCP、SCTP 或 UDP 将消息或流发送到接收应用程序。
5. 应用层接收消息。然后，应用层将执行发送主机所请求的操作。

> 数据封装

下图说明了数据进入协议栈时的封装过程

{% asset_img  picture3.png %}

这里只是把图拿来借鉴一下，来更加直观的了解数据处理过程，[原文戳这里](https://www.cnblogs.com/boyfaceone/p/4615251.html)

接下来就介绍一下 每个Header中对应的结构

####  Header

> TCP Header

​	先看图

{% asset_img  picture4.png %}

上图是一个 TCP header，以下是一些需要「死记硬背」的信息点：

一个 TCP Header 一般有 20 个字节，如果启用了 options，header的长度可以达到 60 个字节。上图中每一行是 4 个 bytes，32 个 bits。我先带大家学习下前 5 行，每一行是 4 Bytes，五行刚好是 20 个 bytes。计算机世界中，通常会以 bit，byte，word（4 个 byte）等不同粒度来描述信息，header 的学习一般是以 4 个字节为一个单位来展示的。

- 第一行，由 Source port 和 Destination port 构成，二者各占 2 个字节，刚好一起占据第一行的 4 个字节。这两个字段分别表示 TCP 连接中的，发送方端口号和接收方的端口号，既然一个 port 只占 2 个 bytes，那么端口值的范围自然就是 0~65535 啦。
- 第二行，Sequence number，表示发送方的序列号。这个序列号表示的是什么呢？一个 TCP 流是有无数个 0 和 1 构成，这些 0 和 1 以 8 个 bit 为单位，可以分割成一个个的 byte，TCP 是可靠传输协议，每一个 byte 都是有标号的，因为我们需要追踪每个 byte 是否被成功传输了，每个 byte 的标号就是我们这里的 sequence number。假设我们建立 TCP 连接的时候，发一个 sync 包，我们就以 0 标记 sync 包的第一个字节，那么 sync 包中的 Sequence 值就是 0。实际应用中，处于安全考虑，TCP 流的第一个 Sequence number 一般不会是 0，而是一个随机数。Sequence number 占据 4 个字节，也就是 2 的 32 次方，这个数字并不算大，每个包都会用掉一些，如果达到最大值之后，就取余从 0 重新开始。
- 第三行，Acknowledge number，表示接收方 ack 的序列号。接收方收到发送方一个的 TCP 包之后，取出其中的 sequence number，在下一个接收方自己要发送的包中，设置 ack 比特位为 1，同时设置 acknowledge number 为 sequence number + 1。所以接收方的 acknowledge number 表示的是，接收方期待接收的下一个包起始字节的标号，大家可以仔细理解下这一句话。所以 acknowledge number 和 sequence number 是配对使用的。
- 第四行，这一行尤其重要，出于篇幅的考虑，其中细节会在后续的文章中讲解。这里简单提下从 CWR 到 FIN 的 8 个 bit，这 8 个 bit 里每一位都是一个标记位，用来标记当前 TCP 包的特殊含义。比如我们所说的三次握手，第一个 sync 包，就是将 SYN 位置为 1。第二个 syn + ack 包就是将 header 的 ACK 和 SYN 位都置为 1。第三个 ack 包即将 ACK 位置 1。剩余的几个 bit 位暂时不展开讲了，大家可以自己看书先学习下。
- 第五行，这一行只有两个字段，即 Checksum 和 Urgent pointer。checksum 是个通用的计算机概念，做完整性校验之用，在很多协议（IP，UDP，ICMP）中都有应用，这个值有包的发送方去计算，之后由包的接收方取出来校验。Urgent pointer 为两个字节的偏移量，加上当前包的 sequence number，用来标记某一个范围内的 bytes 为特殊用途数据。

原文[这里](http://mrpeak.cn/blog/tcp-headers/)

> IPHeader

大概看下吧，具体的名词我也实在是头疼，开始了解的话就了解大概结构体系先。

{% asset_img  picture5.png %}

[更多这里](https://en.wikipedia.org/wiki/IPv4)

> FrameHeader

又吧啦吧啦一堆，[了解更多这里](https://en.wikipedia.org/wiki/Ethernet_frame)

{% asset_img  picture6.png %}

> 再加上 Http Header

Http Header，这个就熟悉了，赶紧抚摸抚摸，吧啦吧啦那么多，就这个前端开发中用到过（小激动）。

- 先上报文图：

  {% asset_img  picture7.png %}

  ​一个HTTP请求报文由请求行（request line）、请求头部（header）、空行和请求数据4个部分组成。

- 常用的请求头

  {% asset_img  picture8.png %}

  这里只列举了部分，还是给到[更多详情](https://en.wikipedia.org/wiki/List_of_HTTP_header_fields)

- 再来一张场景图

  {% asset_img  picture9.png %}

- 对应图

  {% asset_img  picture10.png %}

> 小结

这小结是将数据封装的四个首部对应四个header一一介绍了一下（Appl首部 对应的是Http Header）（以太网首部对应FrameHeader）



#### 理解TCP/IP 各层

到这里相信对网络通信已经有了初步认知，那么再回头看看这TCP/IP协议的四层的作用，来加深一下印象。google，百度给出的答案应该不计其数。

那么就试图用自己的话抓住各层的基本属性和本质特征。

> 应用层

向应用程序提供网络通信，大概有FTP（文件传输协议）HTTP（超文本传输协议）DNS（域名服务器协议）动态主机配置协议 DHCP(苹果手机好像用的是这个)

> 传输层

负责提供可靠的传输服务，协议有TCP（控制传输协议）UDP（用户数据报协议）[不错的解释](http://www.mamicode.com/info-detail-1292289.html)

> 网络互联层

在网络中寻址，数据传输，常见的有IP（网际协议）ICMP（网际控制消息协议）ARP（地址解析协议）

> 网络接口层

负责实际数据的传输，常见的协议有HDLC（高级链路控制协议）PPP（点对点协议）

#### 理解一次Http请求

好吧，作为IOS开发，那就剖析一次手机应用的网络请求的过程：

#### Http 和  Https

https和http都属于application layer，基于TCP（以及UDP）协议，但是又完全不一样。TCP用的port是80， https用的是443端口,[端口具体指的是什么](https://www.zhihu.com/question/22577025/answer/125711899)(这个回答很有意思).

http是HTTP协议运行在TCP之上。所有传输的内容都是明文，客户端和服务器端都无法验证对方的身份。https是HTTP运行在SSL/TLS之上，SSL/TLS运行在TCP之上。所有传输的内容都经过加密，加密采用对称加密，但对称加密的密钥用服务器方的证书进行了非对称加密。

一句话：HTTP+加密+认证+完整性保护=HTTPS

最后这个https足够安全吗？答案是:**世界上没有绝对的安全**

#### IPv4 和 IPv6

> IPv4 和 IPv6 的主要区别

1. IPV6地址长度为128比特，地址窨增大了296倍；
2. 灵活的IP报文头部格式。使用一系列固定格式的扩展头部取代了IPV4中可变长度的选项字段。IPV6中选项部分的出现方式也有所变化，使路由器可以简单路过选项而不做任何处理，加快了报文处理速度。
3. IPV6简化了报文头部格式，字段只有7个，加快报文转发，提高了吞吐量；
4. 提高安全性。身份认证和隐私权是IPV6的关键特性。
5. 支持更多的服务类型；
6. 允许协议继续演变，增加新的功能，使之适应未来技术的发展。

####  TCP 和 UDP的区别

​	在TCP/IP模型中，UDP、TCP为网络层以上和应用层以下提供了的接口。

​	**TCP它把可靠传输机制代码封装成了接口函数API，即socket** ,同时用**TCP Port**来辨别其服务的application Protocol。而application protocol 只需要对自己的协议本身和协议数据做解释，完成端对端的会话。提供一种可靠的传输机制，有状态。

​	**UDP只提供数据的不可靠传递，只提供一个Port来分辨application protocol，是完全无状态协议**，因为UDP无状态，IP也无状态，会话所有的状态都由application protocol 来进行控制。

>  TCP与UDP基本区别

  1.基于连接与无连接

  2.TCP要求系统资源较多，UDP较少； 

  3.UDP程序结构较简单 

  4.流模式（TCP）与数据报模式(UDP); 

  5.TCP保证数据正确性，UDP可能丢包

  6.TCP保证数据顺序，UDP不保证 

[参考地址](http://blog.csdn.net/li_ning_/article/details/52117463)

#### 加密

根据**TCP/IP**的四层 应用层、传输层、网络互联层、网络接口层。

能够提供加密的方案应该在   应用层、传输层、网络互联层（网络层）这三层。(数据链路依赖网线等，所以一般都不考虑)

> 网络层加密

​	那么先看下网络层现有的加密形势，网络层IPSec 协议（IP Security）

​	主要功能是为IP通信提供加密和认证，为 IP 网络通信提供透明的安全服务，保护TCP/IP 通信免遭窃听和篡改，可以有效抵御网络攻击，同时保持易用性。

​	起源：IPSec产生于IPv6的制定之中，用于提供IP层的安全性。由于所有支持TCP／IP协议的主机进行通信时，都要经过IP层的处理，所以提供了IP 层的安全性就相当于为整个网络提供了安全通信的基础。鉴于IPv4的应用仍然很广泛，所以后来在IPSec的制定中也增添了对IPv4的支持，是目前 TCP/IP网络的安全化协议标准。

​	工作模式：IPSec有两种工作模式，一种是隧道模式，另一种是传输模式。传输模式只对IP数据包的有效负载进行加密或认证，此时继续使用原始IP头部。传输模式对IP包的路由支持较好。隧道模式对整个IP数据包进行加密或认证。此时，需要新产生一个IP头部，原来的IP头被加密，有效地防止“中间人”攻击。[参考](http://blog.sina.com.cn/s/blog_71851c8b0101c34f.html)

​	剖析：网络层是三层中最靠近数据流的，此时加密应该是最安全的，但是根据根据图 —  ，网络层还是位于媒介层状态，也就是说任意客户端（也就是图中的主机层）需要解密这些信息的时候，并不知道解密规则，所以就有一定的限制条件，所以可能需要安装一些客户端，或者证书来解密。但是这一点也是致命的影响普及。

> 传输层加密

 	同样看下现有的传输层加密方式有哪些

​	1.SSL：Secure Sockets Layer ，加密套接字协议层。 2.TLS：Transport Layer Security，安全传输层协议。

​	SSL起源：SSL是为网络通信提供安全及数据完整性的一种安全协议,在传输层对网络连接进行加密，用以保障在Internet上数据传输之安全，利用数据加密技术，可确保数据在网络上之传输过程中不会被截取及窃听。

​	SSL工作模式：SSL协议可分为两层：记录协议、握手协议SSL Record Protocol：建立在可靠的传输协议如TCP之上为高层协议提供数据封装、压缩、加密等基本功能。  SSL Handshake Protocol：建立在SSL记录协议之上用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。	[参考](http://blog.51cto.com/xuding/1732275)

​	工作模式：SSL 协议实现步骤总结：

​      	1.客户端生成随机数，建立会话前商定(如约定的加密算法)，服务器端将自己生成的随机数返回

​      	2.服务器端将自己的证书发给客户端，并且请求客户端证书；

​      	3. 客户端检查服务器端的证书(签发者CA、证书有效期、证书内容、证书中名称和通信名称一致、是否吊销)，若检查没问题，客户端将会将自己的证书发给服务端

   	4.服务器端收到客户端证书，检查客户端证书

​      	5.服务端将前面所有信息用hash计算，用自己的公钥签名发给客户端

​	6.客户端机密数据用对方公钥加密后发送给对方

​      	7.双方可以开始进行基于对称加密方式通信

​     	8.客户端请求断开会话，服务器端断开会话

​	剖析：通过 Http(应用层) + SSL(传输层) 也就是Https来加密信息，通过自己公司的服务器和客户端，可以很好的加密解密。也是目前比较流行的方式。

> 应用层加密

​	大概加密方式有Base64、MD5、SHA1等（又到了熟悉用过的东西了2333）

​	好吧，直接说工作模式吧,以常见的Base64、MD5举例：

​	**Base64**：Base64编码可以成为密码学的基石。可以将任意的二进制数据进行Base64编码。IOS/Android 开发语言也提供相应的API，可以直接调用。[参考](http://blog.csdn.net/u011961093/article/details/52611161)

​	**MD5**: 好吧，不多解释了。其大概是：加密后密文的长度是定长（32个字符的密文），且不可以逆推反算（不能根据密文推算出明文），但是可以暴力破解，碰撞监测 ，配合字符串替换使用效果更佳~

​	剖析：使用场景：用户的一些隐私数据加密，密码，手机号等等在前后端传递过程中不容易泄漏。

> 小结

理论上每层都可以加密，好吧，承认写这么多已经开始疲了，就不结了。



####  看哪些书

​	问度娘或者谷歌去吧~（嘻嘻😝）

#### 写在最后

​	这些Tcp/Ip 协议知识，很多都是浅显的东西，很多复杂的协议或者具体实现还有待探索。之前对这一块虽然有些认知但是也比较迷茫，通过这次总结，捋顺不少内容，很多东西作为前端开发很大可能用不到，但是面对重要的网络通信这块，还是希望自己能有一个整体的认知，不要求对每个细节都有所认知，但是整体结构流程希望自己可以娓娓道来。

​	君子不器，不能只停留在只会开车(老司机别想歪)的阶段，闲暇之余，多了解了解其原理，结构体系，应该没有坏处。

完。

